<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Parties - SmartBiz Manager</title>
</head>

<body>
    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <main class="container-fluid">
        <div class="row">
            <nav th:replace="~{fragments/layout :: sidebar}"></nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Parties
                        <span class="badge bg-secondary ms-2" th:text="${#lists.size(parties)}">0</span>
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                                Print
                            </button>
                            <a th:href="@{/pdf/parties}" class="btn btn-sm btn-outline-secondary" id="downloadPdf">
                                <i class="fas fa-file-pdf me-1"></i>
                                PDF
                            </a>
                        </div>
                        <a th:href="@{/parties/new}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            Add Party
                        </a>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control table-search" placeholder="Search parties...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="partyFilter" id="all" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="all">All</label>
                            
                            <input type="radio" class="btn-check" name="partyFilter" id="customers" autocomplete="off">
                            <label class="btn btn-outline-success" for="customers">Customers</label>
                            
                            <input type="radio" class="btn-check" name="partyFilter" id="suppliers" autocomplete="off">
                            <label class="btn btn-outline-warning" for="suppliers">Suppliers</label>
                        </div>
                    </div>
                </div>

                <!-- Parties Table -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="name">
                                            <i class="fas fa-sort me-1"></i>
                                            Name
                                        </th>
                                        <th class="sortable" data-column="type">
                                            <i class="fas fa-sort me-1"></i>
                                            Type
                                        </th>
                                        <th>Contact</th>
                                        <th class="sortable" data-column="balance">
                                            <i class="fas fa-sort me-1"></i>
                                            Current Balance
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${#lists.isEmpty(parties)}">
                                        <td colspan="5" class="text-center py-5">
                                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                            <p class="text-muted mb-2">No parties found</p>
                                            <a th:href="@{/parties/new}" class="btn btn-primary">
                                                <i class="fas fa-plus me-1"></i>
                                                Add Your First Party
                                            </a>
                                        </td>
                                    </tr>
                                    <tr th:each="party : ${parties}" th:data-type="${party.partyType}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-3">
                                                    <div class="avatar-title rounded-circle bg-primary text-white">
                                                        <span th:text="${#strings.substring(party.name, 0, 1)}">A</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0" th:text="${party.name}">Party Name</h6>
                                                    <small class="text-muted" th:text="${party.gstNumber ?: 'No GST Number'}">GST Number</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${party.partyType == T(com.meta.smartbiz.entity.PartyType).CUSTOMER ? 'bg-success' : 
                                                                   party.partyType == T(com.meta.smartbiz.entity.PartyType).SUPPLIER ? 'bg-warning' : 'bg-info'}"
                                                  th:text="${party.partyType}">
                                                Type
                                            </span>
                                        </td>
                                        <td>
                                            <div th:if="${party.phone}">
                                                <i class="fas fa-phone me-1"></i>
                                                <span th:text="${party.phone}">Phone</span>
                                            </div>
                                            <div th:if="${party.email}">
                                                <i class="fas fa-envelope me-1"></i>
                                                <span th:text="${party.email}">Email</span>
                                            </div>
                                            <span th:if="${!party.phone && !party.email}" class="text-muted">No contact info</span>
                                        </td>
                                        <td>
                                            <span class="fw-bold" 
                                                  th:classappend="${party.currentBalance > 0 ? 'text-success' : party.currentBalance < 0 ? 'text-danger' : 'text-muted'}"
                                                  th:text="'₹' + ${#numbers.formatDecimal(party.currentBalance, 0, 2)}">
                                                ₹0.00
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a th:href="@{/parties/edit/{id}(id=${party.id})}" 
                                                   class="btn btn-outline-primary" 
                                                   data-bs-toggle="tooltip" 
                                                   title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a th:href="@{/pdf/party-ledger/{id}(id=${party.id})}" 
                                                   class="btn btn-outline-info" 
                                                   data-bs-toggle="tooltip" 
                                                   title="Download Ledger PDF">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                                <a th:href="@{/parties/delete/{id}(id=${party.id})}" 
                                                   class="btn btn-outline-danger" 
                                                   data-bs-toggle="tooltip" 
                                                   title="Delete"
                                                   onclick="return confirm('Are you sure you want to delete this party?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mt-4" th:if="${!#lists.isEmpty(parties)}">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">Total Receivables</h5>
                                <h3 class="text-success">₹0.00</h3>
                                <small class="text-muted">Amount to receive from customers</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Total Payables</h5>
                                <h3 class="text-danger">₹0.00</h3>
                                <small class="text-muted">Amount to pay to suppliers</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">Net Balance</h5>
                                <h3 class="text-primary">₹0.00</h3>
                                <small class="text-muted">Overall balance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </main>

    <div th:replace="~{fragments/layout :: scripts}"></div>
    
    <script>
        // Party type filter
        document.querySelectorAll('input[name="partyFilter"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const filterType = this.id;
                const rows = document.querySelectorAll('tbody tr[data-type]');
                
                rows.forEach(row => {
                    const partyType = row.getAttribute('data-type');
                    if (filterType === 'all') {
                        row.style.display = '';
                    } else if (filterType === 'customers' && (partyType === 'CUSTOMER' || partyType === 'BOTH')) {
                        row.style.display = '';
                    } else if (filterType === 'suppliers' && (partyType === 'SUPPLIER' || partyType === 'BOTH')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // PDF Download
        // PDF download is now handled by the server-side controller
    </script>
</body>
</html>

